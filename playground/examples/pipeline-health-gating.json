{
  "title": "Gate deployments with CHECKPOINT and ASSERT",
  "description": "Uses FOR EACH normalization, FILTER-based aggregates, and CASE-driven rollout gating.",
  "program": [
    "LET normalized = []",
    "FOR EACH build IN input.builds {",
    "    SET normalized = APPEND(normalized, {",
    "        name: build.name,",
    "        status: build.status,",
    "        duration_minutes: build.duration_seconds / 60",
    "    })",
    "}",
    "",
    "CHECKPOINT(\"normalized builds\")",
    "",
    "LET slowBuilds = FILTER(normalized, (build) -> build.duration_minutes > input.slo_minutes)",
    "LET failures = FILTER(normalized, (build) -> build.status != \"passed\")",
    "CHECKPOINT(\"aggregates prepared\")",
    "LET overallStatus = CASE {",
    "    WHEN LENGTH(failures) > 0 THEN \"failing\"",
    "    WHEN LENGTH(slowBuilds) > 0 THEN \"degraded\"",
    "    ELSE \"passing\"",
    "}",
    "",
    "ASSERT(overallStatus != \"failing\", \"Production build failed\")",
    "",
    "OUTPUT {",
    "    builds: normalized,",
    "    slow_builds: slowBuilds,",
    "    status: overallStatus,",
    "    explain_status: EXPLAIN(\"overallStatus\")",
    "}"
  ],
  "input": {
    "slo_minutes": 10,
    "builds": [
      {
        "name": "api",
        "status": "passed",
        "duration_seconds": 540
      },
      {
        "name": "web",
        "status": "passed",
        "duration_seconds": 900
      },
      {
        "name": "mobile",
        "status": "passed",
        "duration_seconds": 480
      }
    ]
  },
  "trace": true
}
