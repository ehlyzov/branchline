{
  "title": "Contract deep composition",
  "description": "Build nested output through stdlib-driven totals and CASE-based status composition to demonstrate deep V2 contract inference.",
  "program": [
    "LET suites = FILTER(LISTIFY(input.report.suites ?? []), (suite) -> suite != NULL)",
    "LET normalized = []",
    "FOR EACH suite IN suites {",
    "    SET normalized = APPEND(normalized, {",
    "        id: suite.id ?? \"unknown\",",
    "        metrics: {",
    "            tests: NUMBER(suite.tests ?? 0),",
    "            failures: NUMBER(suite.failures ?? 0)",
    "        }",
    "    })",
    "}",
    "",
    "LET totals = {",
    "    tests: SUM(MAP(normalized, (suite) -> suite.metrics.tests)),",
    "    failures: SUM(MAP(normalized, (suite) -> suite.metrics.failures))",
    "}",
    "",
    "LET summary = {",
    "    healthy: totals.failures == 0,",
    "    totals: totals",
    "}",
    "",
    "LET badge = {",
    "    status: CASE {",
    "        WHEN summary.healthy THEN \"passing\"",
    "        ELSE \"failing\"",
    "    },",
    "    summary: summary",
    "}",
    "",
    "LET suitesOut = []",
    "FOR EACH suite IN normalized {",
    "    SET suitesOut = APPEND(suitesOut, {",
    "        id: suite.id,",
    "        quality: {",
    "            status: CASE {",
    "                WHEN suite.metrics.failures == 0 THEN \"green\"",
    "                ELSE \"red\"",
    "            }",
    "        },",
    "        metrics: suite.metrics",
    "    })",
    "}",
    "",
    "OUTPUT {",
    "    badge: badge,",
    "    suites: suitesOut",
    "}"
  ],
  "input": {
    "report": {
      "suites": [
        {
          "id": "api",
          "tests": "5",
          "failures": "0"
        },
        {
          "id": "web",
          "tests": "8",
          "failures": "1"
        }
      ]
    }
  }
}
