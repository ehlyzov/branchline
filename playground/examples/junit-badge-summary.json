{
  "title": "Summarize JUnit XML (simple)",
  "description": "Normalize testsuite data with FILTER + FOR EACH and derive totals and badge status via SUM/MAP + CASE.",
  "program": [
    "LET root = input.testsuites ?? input.testsuite ?? {}",
    "LET suitesRaw = root.testsuite ?? root",
    "LET suites = CASE {",
    "    WHEN suitesRaw == NULL THEN []",
    "    WHEN IS_OBJECT(suitesRaw) THEN [suitesRaw]",
    "    ELSE suitesRaw",
    "}",
    "",
    "LET normalizedSuites = []",
    "FOR EACH suite IN FILTER(suites, (item) -> item != NULL) {",
    "    SET normalizedSuites = APPEND(normalizedSuites, {",
    "        name: suite[\"@name\"] ?? suite[\"@package\"] ?? \"unnamed suite\",",
    "        tests: NUMBER(suite[\"@tests\"] ?? 0),",
    "        failures: NUMBER(suite[\"@failures\"] ?? 0),",
    "        errors: NUMBER(suite[\"@errors\"] ?? 0),",
    "        skipped: NUMBER(suite[\"@skipped\"] ?? 0)",
    "    })",
    "}",
    "",
    "LET totals = {",
    "    tests: SUM(MAP(normalizedSuites, (suite) -> suite.tests)),",
    "    failures: SUM(MAP(normalizedSuites, (suite) -> suite.failures)),",
    "    errors: SUM(MAP(normalizedSuites, (suite) -> suite.errors)),",
    "    skipped: SUM(MAP(normalizedSuites, (suite) -> suite.skipped))",
    "}",
    "",
    "LET failed = totals.failures + totals.errors",
    "LET status = CASE {",
    "    WHEN totals.tests == 0 THEN \"error\"",
    "    WHEN failed == 0 THEN \"passing\"",
    "    ELSE \"failing\"",
    "}",
    "",
    "OUTPUT {",
    "    status: status,",
    "    totals: totals,",
    "    suites: normalizedSuites",
    "}"
  ],
  "input": {
    "testsuites": {
      "@name": "All",
      "@tests": 12,
      "@failures": 1,
      "@errors": 0,
      "@skipped": 2,
      "testsuite": [
        {
          "@name": "api.tests.UserTest",
          "@tests": 5,
          "@failures": 1,
          "@errors": 0,
          "@skipped": 1
        },
        {
          "@name": "web.tests.CartTest",
          "@tests": 7,
          "@failures": 0,
          "@errors": 0,
          "@skipped": 1
        }
      ]
    }
  }
}
